schema: 1
commands:
  doctor:
    description: Inspect environment and report tool availability.
    outputs:
      - path: "exports/doctor.json"
        schema:
          _meta:
            generated_at: string
          tool:
            found: bool
            path: string|null
            version_line: string|null

  context-export:
    description: Collect artifacts LLMs rely on.
    runs:
      - "modules/compile_db.sh"
      - "modules/cmake_introspect.sh"
    outputs:
      - path: "exports/compile_commands.json"
      - path: "exports/cmake-file-api/*.json"
      - path: "exports/context.json"
        schema:
          compile_commands: string|null
          cmake_file_api:
            dir: string
            files: [string]
          generated_at: string
    json_summary: "exports/context.json"

  analyze:
    description: Run clang-tidy + IWYU + cppcheck with JSON reports.
    args:
      - name: paths
        variadic: true
      - name: sarif
        flag: true
        description: "Output results in SARIF format"
    runs:
      - "modules/analyze.sh"
    outputs:
      - path: "exports/reports/clang-tidy.json"
        schema:
          available: bool
          version: string|null
          inputs: [string]
          diagnostics:
            - file: string
              line: int
              col: int
              severity: string
              msg: string
              check: string|null
          fixes:
            - file: string
              message: string
              file_offset: int
              replacements:
                - file: string
                  offset: int
                  length: int
                  replacement: string
      - path: "exports/reports/iwyu.json"
        schema:
          available: bool
          version: string|null
          suggestions:
            - file: string
              add: [string]
              remove: [string]
      - path: "exports/reports/cppcheck.json"
        schema:
          available: bool
          version: string|null
          diagnostics:
            - id: string
              severity: string
              msg: string
              verbose: string
              locations:
                - file: string
                  line: int
                  column: int
      - path: "exports/reports/analysis.sarif"
        condition: "sarif flag set"
        schema:
          version: string
          "$schema": string
          runs:
            - tool:
                driver:
                  name: string
                  version: string
                  rules: [object]
              results:
                - ruleId: string
                  message:
                    text: string
                  level: string
                  locations: [object]

  reduce:
    description: Minimize a failing repro with cvise.
    args:
      - { name: input, required: true }
      - { name: test_cmd, required: true }
    runs:
      - "modules/reduce.sh"
    outputs:
      - path: "exports/repros/minimized.cpp"
      - path: "exports/repros/report.json"
        schema:
          cvise_available: bool
          exit_code: int|null
          input: string

  capabilities:
    description: Emit machine-readable toolkit capabilities summary.
    outputs:
      - path: "exports/capabilities.json"
        schema:
          _meta:
            generated_at: string
            toolkit_version: string
            tools_manifest: string
            commands_manifest: string
          tools: object
          commands: object

  tidy:
    description: Run clang-tidy with optional fix application.
    args:
      - name: paths
        variadic: true
      - name: apply
        flag: true
        description: "Apply suggested fixes"
      - name: checks
        description: "Specify which checks to run"
    examples:
      - "llmtk tidy src/"
      - "llmtk tidy --apply src/"
      - "llmtk tidy --checks='*' src/"

  format:
    description: Run clang-format on code with check or apply options.
    args:
      - name: paths
        variadic: true
      - name: check
        flag: true
        description: "Check if files are formatted (dry run)"
      - name: apply
        flag: true
        description: "Apply formatting changes"
      - name: style
        description: "Formatting style (file, LLVM, Google, etc.)"
    examples:
      - "llmtk format --check src/"
      - "llmtk format --apply src/"
      - "llmtk format --style=Google src/"

  gate:
    description: Enforce SARIF severity budgets for CI gating.
    args:
      - name: sarif_file
        required: true
        description: "Path to SARIF file to check"
      - name: max-errors
        description: "Maximum allowed errors (default: 0)"
      - name: max-warnings
        description: "Maximum allowed warnings (default: 10)"
      - name: max-notes
        description: "Maximum allowed notes (default: 50)"
      - name: config
        description: "Path to gate configuration file"
    outputs:
      - exit_code: "0 for pass, 1 for fail"
    examples:
      - "llmtk gate exports/reports/analysis.sarif"
      - "llmtk gate --max-warnings=5 analysis.sarif"
      - "llmtk gate --config=.llmtk-gate.yaml analysis.sarif"
