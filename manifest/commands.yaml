schema: 1
commands:
  doctor:
    description: Inspect environment and report tool availability.
    outputs:
      - path: "exports/doctor.json"
        schema:
          _meta:
            generated_at: string
          tool:
            found: bool
            path: string|null
            version_line: string|null

  context-export:
    description: Collect artifacts LLMs rely on.
    runs:
      - "modules/compile_db.sh"
      - "modules/cmake_introspect.sh"
    outputs:
      - path: "exports/compile_commands.json"
      - path: "exports/cmake-file-api/*.json"
      - path: "exports/context.json"
        schema:
          compile_commands: string|null
          cmake_file_api:
            dir: string
            files: [string]
          generated_at: string
    json_summary: "exports/context.json"

  analyze:
    description: Run clang-tidy + IWYU + cppcheck with JSON reports.
    args:
      - name: paths
        variadic: true
    runs:
      - "modules/analyze.sh"
    outputs:
      - path: "exports/reports/clang-tidy.json"
        schema:
          available: bool
          version: string|null
          inputs: [string]
          diagnostics:
            - file: string
              line: int
              col: int
              severity: string
              msg: string
              check: string|null
          fixes:
            - file: string
              message: string
              file_offset: int
              replacements:
                - file: string
                  offset: int
                  length: int
                  replacement: string
      - path: "exports/reports/iwyu.json"
        schema:
          available: bool
          version: string|null
          suggestions:
            - file: string
              add: [string]
              remove: [string]
      - path: "exports/reports/cppcheck.json"
        schema:
          available: bool
          version: string|null
          diagnostics:
            - id: string
              severity: string
              msg: string
              verbose: string
              locations:
                - file: string
                  line: int
                  column: int

  reduce:
    description: Minimize a failing repro with cvise.
    args:
      - { name: input, required: true }
      - { name: test_cmd, required: true }
    runs:
      - "modules/reduce.sh"
    outputs:
      - path: "exports/repros/minimized.cpp"
      - path: "exports/repros/report.json"
        schema:
          cvise_available: bool
          exit_code: int|null
          input: string
